version: '3.8'

services:
  learning-platform-backend:
    build: .
    container_name: learning-platform-backend
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=production
      - MEDIA_PATH=/media
      - PORT=5000
      - DB_PATH=/app/data/database.db
    volumes:
      # Mount your course media folder (READ-ONLY for safety)
      - C:/Users/anant/Desktop/CourseMedia:/media:ro
      # Mount database directory (READ-WRITE)
      - ./data:/app/data
    networks:
      - jobtrak-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/api/health')"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # HTTPS Router (websecure)
      - "traefik.http.routers.learning-platform.rule=Host(`jobtrackai.duckdns.org`) && PathPrefix(`/learn`)"
      - "traefik.http.routers.learning-platform.entrypoints=websecure"
      - "traefik.http.routers.learning-platform.tls=true"
      - "traefik.http.routers.learning-platform.tls.certresolver=letsencrypt"
      - "traefik.http.routers.learning-platform.priority=100"

      # Service - explicitly link to this container
      - "traefik.http.services.learning-platform-service.loadbalancer.server.port=5000"
      - "traefik.http.routers.learning-platform.service=learning-platform-service"

      # Health check for load balancer
      - "traefik.http.services.learning-platform-service.loadbalancer.healthcheck.path=/api/health"
      - "traefik.http.services.learning-platform-service.loadbalancer.healthcheck.interval=10s"

      # Strip prefix middleware
      - "traefik.http.middlewares.learning-platform-stripprefix.stripprefix.prefixes=/learn"

      # CORS headers middleware
      - "traefik.http.middlewares.learning-platform-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,OPTIONS,PATCH,HEAD"
      - "traefik.http.middlewares.learning-platform-cors.headers.accesscontrolalloworiginlist=https://streaming-service.vercel.app,https://jobtrackai.duckdns.org,http://localhost:3000"
      - "traefik.http.middlewares.learning-platform-cors.headers.accesscontrolallowcredentials=true"
      - "traefik.http.middlewares.learning-platform-cors.headers.accesscontrolallowheaders=Content-Type,Authorization,X-Requested-With,Range,Accept"
      - "traefik.http.middlewares.learning-platform-cors.headers.accesscontrolmaxage=3600"

      # Apply middlewares in order: CORS first, then strip prefix
      - "traefik.http.routers.learning-platform.middlewares=learning-platform-cors,learning-platform-stripprefix"

      # HTTP to HTTPS redirect
      - "traefik.http.routers.learning-platform-http.rule=Host(`jobtrackai.duckdns.org`) && PathPrefix(`/learn`)"
      - "traefik.http.routers.learning-platform-http.entrypoints=web"
      - "traefik.http.routers.learning-platform-http.priority=100"
      - "traefik.http.middlewares.learning-platform-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.learning-platform-https-redirect.redirectscheme.permanent=true"
      - "traefik.http.routers.learning-platform-http.middlewares=learning-platform-https-redirect"

networks:
  jobtrak-network:
    external: true
